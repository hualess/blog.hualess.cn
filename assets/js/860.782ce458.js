(window.webpackJsonp=window.webpackJsonp||[]).push([[860],{1445:function(a,s,e){"use strict";e.r(s);var n=e(2),t=Object(n.a)({},(function(){var a=this,s=a.$createElement,e=a._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("p",[a._v("准备给开源项目做一个镜像，由于当前使用的是 M1 型号的 Mac 电脑，打出来的镜像无法运行在 AMD 架构之上，但是在 dockerhub 上又见过一些比较大的项目的镜像，支持多平台，因此就了解了一波，本文记录一下实操过程。")]),a._v(" "),e("p",[a._v("在 docker 官方文档中，也有对这块儿内容的讲解，参考： "),e("a",{attrs:{href:"https://docs.docker.com/desktop/multi-arch/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Leverage multi-CPU architecture support"),e("OutboundLink")],1)]),a._v(" "),e("p",[a._v("核心点是：Docker 在 19.03 版本引入了构建插件 "),e("a",{attrs:{href:"https://github.com/docker/buildx",target:"_blank",rel:"noopener noreferrer"}},[a._v("buildx"),e("OutboundLink")],1),a._v(" ，可以很轻松地构建多平台 Docker 镜像。")]),a._v(" "),e("h2",{attrs:{id:"启用-buildx-插件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启用-buildx-插件"}},[a._v("#")]),a._v(" 启用 buildx 插件")]),a._v(" "),e("p",[a._v("使用之前确保自己的 docker 版本不低于 19.03，通过如下方式查看自己的 docker 版本：")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[a._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v("\nDocker version "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("20.10")]),a._v(".13, build a224086\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br")])]),e("p",[a._v("启用 buildx 插件：")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("DOCKER_CLI_EXPERIMENTAL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("enabled\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("验证是否开启：")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[a._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" buildx version\ngithub.com/docker/buildx v0.8.1 5fac64c2c49dae1320f2b51f1a899ca451935554\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br")])]),e("p",[a._v("使用桌面版的 docker 已经提供 "),e("code",[a._v("binfmt_misc")]),a._v(" 多架构支持，这意味着您可以为不同的 Linux 架构运行容器，例如 "),e("code",[a._v("arm")]),a._v("、"),e("code",[a._v("mips")]),a._v("、"),e("code",[a._v("ppc64le")]),a._v(" 甚至 "),e("code",[a._v("s390x")]),a._v("，因此不需要再单独配置。")]),a._v(" "),e("h4",{attrs:{id:"从默认的构建器切换到多平台构建器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#从默认的构建器切换到多平台构建器"}},[a._v("#")]),a._v(" 从默认的构建器切换到多平台构建器")]),a._v(" "),e("p",[a._v("Docker 默认会使用不支持多 CPU 架构的构建器，我们需要手动切换。")]),a._v(" "),e("p",[a._v("先创建一个新的构建器：")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[a._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" buildx create "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--use")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" mybuilder\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("然后启动构建器：")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[a._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" buildx inspect mybuilder "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--bootstrap")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("+"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" Building "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("32")]),a._v(".6s "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("/1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" FINISHED\n "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("internal"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" booting buildkit                                                                                                           "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("32")]),a._v(".5s\n "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" pulling image moby/buildkit:buildx-stable-1                                                                                        "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("31")]),a._v(".8s\n "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" creating container buildx_buildkit_mybuilder0                                                                                       "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".7s\nName:   mybuilder\nDriver: docker-container\n\nNodes:\nName:      mybuilder0\nEndpoint:  unix:///var/run/docker.sock\nStatus:    running\nPlatforms: linux/arm64, linux/amd64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/mips64le, linux/mips64, linux/arm/v7, linux/arm/v6\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br")])]),e("p",[a._v("查看当前使用的构建器支持的 CPU 架构：")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[a._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" buildx "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v("\nNAME/NODE       DRIVER/ENDPOINT             STATUS  PLATFORMS\nmybuilder *     docker-container\n  mybuilder0    unix:///var/run/docker.sock running linux/arm64, linux/amd64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/mips64le, linux/mips64, linux/arm/v7, linux/arm/v6\ndesktop-linux   "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n  desktop-linux desktop-linux               running linux/arm64, linux/amd64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6\ndefault         "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v("\n  default       default                     running linux/arm64, linux/amd64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br")])]),e("h2",{attrs:{id:"基于-dockerfile-构建"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基于-dockerfile-构建"}},[a._v("#")]),a._v(" 基于 Dockerfile 构建")]),a._v(" "),e("p",[a._v("我们准备好项目的 Dockerfile，并做好 dockerhub 的认证，然后开始构建镜像，并直接推送到 dockerhub。")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[a._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" buildx build "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" eryajf/go-ldap-admin "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--platform")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("linux/arm64,linux/amd64 "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--push")]),a._v("\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("此时来到 dockerhub 中看这个镜像，也能看到多平台支持的标识了：")]),a._v(" "),e("p",[e("img",{attrs:{src:"http://t.eryajf.net/imgs/2022/05/7b99d9255193df82.jpg",alt:""}})]),a._v(" "),e("p",[a._v("我们也可以通过命令行查看每个镜像的信息：")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[a._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" buildx imagetools inspect eryajf/go-ldap-admin\nName:      docker.io/eryajf/go-ldap-admin:latest\nMediaType: application/vnd.docker.distribution.manifest.list.v2+json\nDigest:    sha256:e70c93a079f64bf3b11beb5bb5c3365d521ab150ceaccc5c0318ccc94945aa48\n\nManifests:\n  Name:      docker.io/eryajf/go-ldap-admin:latest@sha256:af9f6c43744850e8430124cfa2a3d7faaa998b31e0db500e8e005d7916e3bec2\n  MediaType: application/vnd.docker.distribution.manifest.v2+json\n  Platform:  linux/arm64\n\n  Name:      docker.io/eryajf/go-ldap-admin:latest@sha256:fcf385c734aaf1d7ee9ebc69925f457c6fae5c84df9beffb354b875b0cfc7409\n  MediaType: application/vnd.docker.distribution.manifest.v2+json\n  Platform:  linux/amd64\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br")])]),e("p",[a._v("当我们在使用并拉取这个镜像的时候，docker 会根据 CPU 架构拉取匹配的镜像。")]),a._v(" "),e("ul",[e("li",[a._v("参考：\n"),e("ul",[e("li",[e("a",{attrs:{href:"https://docs.docker.com/desktop/multi-arch/",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://docs.docker.com/desktop/multi-arch/"),e("OutboundLink")],1)]),a._v(" "),e("li",[e("a",{attrs:{href:"https://cloud.tencent.com/developer/article/1543689",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://cloud.tencent.com/developer/article/1543689"),e("OutboundLink")],1)])])])])])}),[],!1,null,null,null);s.default=t.exports}}]);